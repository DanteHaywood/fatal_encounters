<!DOCTYPE html>
<html lang="en-US">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=Edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Fatal Encounters</title>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
	<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
	<script src="https://d3js.org/d3.v5.min.js"></script>

</head>
<body>
	<div class = "content" id="chart-content">

		<div class="chart-container">
			<canvas id="myChart"></canvas>
		</div>

		<h3>hurrrrr</h3>

		<div class="chart-container my-5">
			<canvas id="feByYear"></canvas>
		</div>

		<div class="chart-container my-5">
			<canvas id="feByRace"></canvas>
		</div>

		<div class="container pt-5">
			<div class="row mx-md-n5">
			  <div class="col px-md-5" align='center'>
					<button id = 'race-metric-button' type="button" class="btn btn-dark btn-lg">Switch to % of Race Population</button>
				</div>
			</div>
		</div>

	</div>

	<script>

	$(document).ready(function(){
		d3.csv("https://raw.githubusercontent.com/DanteHaywood/fatal_encounters/master/FATAL%20ENCOUNTERS%20WEB.csv")
		.then(function(data) {
			// Data from d3.csv is parsed into rows as objects and columns into key-values
			// Need to transform the row-wise structure into single columns as arrays
			// Chart.js needs data as "columnar" arrays - the opposite of d3
		  console.log(data);
			/*
			var ages = [],
				dates = [],
				genders = [],
				years = [],
				races = []

			data.map(function(d) {
				ages.push(d.age);
				dates.push(d.dates);
				genders.push(d.gender);
				years.push(d.years);
				races.push(d.race_imputation);
			})
			*/

			// Dynamically set chart size base on viewer device
			var size = {
			  width: $('#chart-content').parent().width() * 0.95,
			  height: document.documentElement.clientHeight * 0.8
			}

			const groupCount = function(data, group){

				var nested = d3.nest()
					.key(function(d) { return d[group] })
					.rollup(function(d) {
						return d3.sum(d, function(g) { return 1 })
					})
					.entries(data)
				;

				nested = nested.filter(function(d){
					keyUpper = d.key.toUpperCase();
					return (
						(keyUpper !== "#REF!") &&
						(keyUpper !== "#VALUE!") &&
						(keyUpper !== "2100") &&
						(keyUpper !== "NA") &&
						(keyUpper !== "NULL") &&
						// Remove erroneous data
						(d.value > 3)
					)
				})

				return nested;
			}

			const feByYear = groupCount(data, "year");
			const feByGender = groupCount(data, "gender");
			const feByRace = groupCount(data, "race_imputation");

			//https://www.pewresearch.org/hispanic/2015/09/28/appendix-c-population-tables-1965-2065/
			const feByRacePerCapita = feByRace.map(function(d){
				if(d.key == 'African-American/Black'){
					value = 100 * d.value / 42039000;
				} else if(d.key == 'European-American/White'){
					value = 100 * d.value / 246940000;
				} else if(d.key == 'Hispanic/Latino'){
					value = 100 * d.value / 55410000;
				} else if(d.key == 'Race unspecified'){
					value = 100 * d.value / 55410000;
				} else if(d.key == 'Asian/Pacific Islander'){
					value = 100 * d.value / (17083000 + 734000);
				} else if(d.key == 'Native American/Alaskan'){
					value = 100 * d.value / 3957000;
				} else if(d.key == 'Other Race'){
					value = 0;
				}
				else if(d.key == 'Middle Eastern'){
					value = 0;
				} else {
					value = 0;
				}

				return {'key':d.key, 'value':value}
			})
			console.log(feByRace);
			console.log(feByRacePerCapita);

			const getKeys = function(obj){
				var keys = [];
				obj.map(function(d){
					keys.push(d.key)
				})
				return keys;
			}

			const getValues = function(obj){
				var values = [];
				obj.map(function(d){
					values.push(d.value)
				})
				return values;
			}

			const get_random_color = function() {
			  function c() {
			    var hex = Math.floor(Math.random()*256).toString(16);
			    return ("0"+String(hex)).substr(-2); // pad with zero
			  }
			  return "#"+c()+c()+c();
			}

			var raceMetric = 'perCapita',
				feByRaceMetric = feByRace
			;

			const toggleRaceMetric = function(){
				if(raceMetric == 'raw'){
					feByRaceMetric = feByRace;
					raceMetric = 'perCapita';
					document.getElementById('race-metric-button')
						.textContent = 'Switch to % of Race Population';
				} else {
					feByRaceMetric = feByRacePerCapita;
					raceMetric = 'raw';
					document.getElementById('race-metric-button')
						.textContent = 'Switch to Raw Count';
				}
				newData = {
					"labels":getKeys(feByRaceMetric),
					"data":getValues(feByRaceMetric)
				}

				newChartDataset(feByRaceChart, newData)
			}

			function newChartDataset(chart, data) {
			    chart.data.labels = data.labels;
			    chart.data.datasets.forEach((dataset) => {
			        dataset.data = data.data;
			    });
			    chart.update();
			}



			///////////////////////
			// FE by Year Line Chart
			///////////////////////
			var ctx_feByYear = document.getElementById('feByYear').getContext('2d');
			ctx_feByYear.canvas.width = size.width;
			ctx_feByYear.canvas.height = size.height;
			var feByYearChart = new Chart(ctx_feByYear,{
				"type":"line",

				"data":{
					"labels":getKeys(feByYear),

					"datasets":[{
						"label":"Fatal Encounters",
						"data":getValues(feByYear),
						"backgroundColor":"#d10000",
						"fill":false,
						"borderColor":"#d10000",
						"pointHoverRadius":10,
						"lineTension":0.1}
					]},
				"options":{
					title: {
						display: true,
						text: 'Fatal Encounters by Year'
					}
				}
			});

				///////////////////////
				// FE by Race bar Chart
				///////////////////////

				var ctx_feByRace = document.getElementById('feByRace').getContext('2d');
				ctx_feByRace.canvas.width = size.width;
				ctx_feByRace.canvas.height = size.height;
				var feByRaceChart = new Chart(ctx_feByRace,{
					"type":"doughnut",

					"data":{
						"labels":getKeys(feByRaceMetric),
						"datasets":[{
							//"label":"Fatal Encounters",
							"data":getValues(feByRaceMetric),
							"backgroundColor":d3.schemeCategory10,
							"weight":2}
						]},
					"options":{
						title: {
							display: true,
							text: 'Fatal Encounters by Race'
						}
					}
				});

				document.getElementById('race-metric-button').addEventListener('click', toggleRaceMetric);


		});
	})
	</script>
</body>
</html>
